# Database Seeding

This directory contains the database seeding infrastructure for the Skills Platform. The seeding system generates realistic fake data for development and testing purposes while preserving the admin-seeded skills taxonomy.

## Overview

The seeding system is organized into modular seed files, each responsible for a specific domain:

- **skills.seed.ts** - Seeds 136 skills across 19 disciplines
- **sample-data.seed.ts** - Seeds profiles, projects, assignments, employee skills, suggestions, and seniority history
- **seed-utils.ts** - Shared utility functions for data generation
- **skill-context.ts** - Maps project types to relevant skill disciplines

## Architecture

```
prisma/
├── seed.ts                  # Main orchestrator
└── seeds/
    ├── skills.seed.ts       # Skills taxonomy seeding
    ├── sample-data.seed.ts  # Sample data seeding
    ├── seed-utils.ts        # Shared utilities
    ├── skill-context.ts     # Skill-project context mapping
    ├── seed.spec.ts         # Tests
    └── README.md            # This file
```

## Usage

### Run Full Seed

```bash
cd /Users/anthonyulloa/Desktop/Projects/personal/skills-platform/apps/api
pnpm prisma db seed
```

This command executes the main orchestrator (`seed.ts`) which runs:
1. Skills taxonomy seeding (136 skills)
2. Sample data seeding (profiles, projects, assignments, etc.)

### Reset Database and Seed

```bash
cd /Users/anthonyulloa/Desktop/Projects/personal/skills-platform/apps/api
pnpm prisma migrate reset
```

This command:
1. Drops the database
2. Recreates the schema
3. Runs migrations
4. Automatically runs the seed script

## Data Volumes and Distributions

### Profiles (25)
- **Total:** 25 profiles with realistic names generated by Faker.js
- **Email Format:** firstname.lastname@ravn.com
- **Seniority Distribution (Organizational Pyramid):**
  - Junior: 40% (~10 profiles)
  - Mid: 30% (~7 profiles)
  - Senior: 20% (~5 profiles)
  - Lead: 10% (~3 profiles, minimum 5-10 to satisfy Tech Lead requirements)

### Projects (7)
- **Total:** 7 projects with unique Tech Leads
- **Tech Lead Assignment:** Each project has exactly one Tech Lead from Lead seniority profiles
- **Constraint:** No Tech Lead leads multiple projects (one-to-one mapping)
- **Project Types:** MOBILE, BACKEND, FRONTEND, FULLSTACK

### Assignments
- **Distribution:**
  - 60-70% of employees on 1 project
  - 20-30% of employees on 2 projects
  - 5-10% of employees on 3 projects
- **All employees assigned:** No bench employees (0% unassigned)
- **Roles:** Context-aware roles based on project type (e.g., "Mobile Developer" for mobile projects)
- **Tags:** 1-3 relevant tags per assignment (e.g., ["react-native", "ios"] for mobile)

### Employee Skills
- **Per Profile:** 3-7 validated skills
- **Context Awareness:** Skills align with employee's project assignments
  - Mobile projects → MOBILE, FRONTEND, iOS, ANDROID skills
  - Backend projects → BACKEND, DATABASE, CLOUD, DEVOPS skills
  - Frontend projects → FRONTEND, STYLING, DESIGN skills
  - Full-stack projects → Mix of all disciplines
- **Proficiency Distribution:**
  - Novice: 10%
  - Intermediate: 40%
  - Advanced: 40%
  - Expert: 10%
- **Seniority Constraints:**
  - Junior employees: No EXPERT proficiency
  - Lead employees: More ADVANCED/EXPERT skills
- **Validation Metadata:**
  - ValidatedAt: Random dates from 1 week to 12 months ago
  - ValidatedById: 70-80% assigned to Tech Leads/Senior profiles, 20-30% null

### Skill Suggestions
- **Per Profile:** 1-3 pending suggestions
- **Distribution:**
  - 60% of profiles have 1 suggestion
  - 30% of profiles have 2 suggestions
  - 10% of profiles have 3 suggestions
- **Source:** SELF_REPORT
- **Status:** PENDING
- **Created Dates:** Within last 1-2 weeks (recent)
- **Context Awareness:** Suggested skills align with project assignments
- **Proficiency Logic:**
  - New skills: Suggest NOVICE or INTERMEDIATE based on seniority
  - Existing skills: Suggest next level up (NOVICE → INTERMEDIATE, etc.)

### Seniority History
- **Per Profile:** 1-3 records showing career progression
- **Progression Examples:**
  - Junior: 1 record (hired as Junior)
  - Mid: 1-2 records (Junior → Mid)
  - Senior: 2-3 records (Junior → Mid → Senior)
  - Lead: 2-3 records (Mid → Senior → Lead)
- **Sequential Only:** No lateral moves
- **Date Range:** Effective dates span 1-3 years
- **Chronology:** Earlier promotions before later ones
- **CreatedById:** 70% assigned to senior profiles, 30% null

## Idempotent Behavior

The seeding system is **idempotent** - it can be run multiple times safely:

1. **Cleanup Phase:** Before seeding, all existing sample data is deleted in the correct order to handle foreign key constraints:
   - SeniorityHistory (child of Profile)
   - Suggestion (child of Profile and Skill)
   - EmployeeSkill (child of Profile and Skill)
   - Assignment (child of Profile and Project)
   - Project (references Profile as Tech Lead)
   - Profile (parent table)

2. **Preservation:** The 136 admin-seeded skills in the Skill table are **never deleted or modified**

3. **Atomicity:** All deletions and creations are wrapped in a Prisma transaction - either all succeed or all rollback

4. **Deterministic Results:** Uses Faker.js with a fixed seed (12345) to produce consistent data across runs

## Data Integrity Validations

After seeding, the system validates:

- All emails use @ravn.com domain
- All Tech Leads have LEAD seniority level
- All projects have exactly one Tech Lead
- Assignment distribution matches target percentages (within 10% tolerance)
- Seniority history dates are chronological
- No duplicate skills per profile

## Expected Output

```
╔════════════════════════════════════════╗
║   DATABASE SEEDING ORCHESTRATOR       ║
╚════════════════════════════════════════╝

Starting skills taxonomy seeding...
Created: React (FRONTEND)
...
Successfully seeded 136 skills (136 created, 0 updated)

========================================
Starting sample data seeding...
========================================

[1/7] Cleaning up existing sample data...
  Preserving 136 existing skills...
  Deleted: 75 seniority histories, 50 suggestions, 125 employee skills
  Deleted: 40 assignments, 7 projects, 25 profiles
  Verified 136 skills preserved

[2/7] Generating profiles...
  Created 25 profiles (10 Junior, 7 Mid, 5 Senior, 3 Lead)

[3/7] Generating seniority history...
  Created 75 seniority history records

[4/7] Generating projects...
  Created 7 projects with unique Tech Leads

[5/7] Generating assignments...
  Created 40 assignments (16 on 1 project, 7 on 2 projects, 2 on 3 projects)

[6/7] Generating employee skills...
  Created 125 employee skills (avg 5.0 per profile)
  Proficiency distribution: 12 NOVICE, 50 INTERMEDIATE, 50 ADVANCED, 13 EXPERT

[7/7] Generating skill suggestions...
  Created 50 skill suggestions (15 profiles with 1, 7 with 2, 3 with 3)
  All suggestions set to PENDING status from SELF_REPORT source

Validating data integrity...
  All emails use @ravn.com domain
  All Tech Leads have LEAD seniority level
  All projects have exactly one Tech Lead
  Assignment distribution: 64.0% on 1 project, 28.0% on 2, 8.0% on 3
  All data integrity checks passed

========================================
Sample data seeding completed successfully!
========================================
Total time elapsed: 2.45 seconds

╔════════════════════════════════════════╗
║   ALL SEEDING COMPLETED SUCCESSFULLY  ║
╚════════════════════════════════════════╝
Total execution time: 3.12 seconds
```

## Troubleshooting

### Common Issues and Solutions

#### "Insufficient Lead profiles for Tech Lead assignments"
**Cause:** Not enough Lead seniority profiles generated
**Solution:** The seed script automatically ensures at least 5-10 Lead profiles. If this error occurs, check the seniority distribution logic in `sample-data.seed.ts`

#### "Unique constraint violation on email"
**Cause:** Duplicate email addresses generated
**Solution:** Ensure Faker.js is initialized with a seed for deterministic results. The seed script uses `initializeFaker(12345)` to prevent this.

#### "Foreign key constraint error"
**Cause:** Attempting to delete parent records before child records
**Solution:** The cleanup phase deletes records in the correct order. Verify the deletion sequence in `sample-data.seed.ts`

#### "Seeding takes too long"
**Cause:** Large data volumes or slow database connection
**Solution:** The current configuration generates 25 profiles, 7 projects, and related data - a reasonable volume for development. Reduce `PROFILE_COUNT` and `PROJECT_COUNT` constants in `sample-data.seed.ts` if needed.

#### "Skills were modified during cleanup"
**Cause:** Cleanup logic accidentally deleted skills
**Solution:** The cleanup phase explicitly skips the Skill table and validates the count before and after. If this error occurs, investigate the cleanup logic.

### Resetting Database

**Option 1: Full Reset (recommended)**
```bash
cd /Users/anthonyulloa/Desktop/Projects/personal/skills-platform/apps/api
pnpm prisma migrate reset
```
This drops the database, recreates schema, runs migrations, and seeds data.

**Option 2: Push Schema and Seed**
```bash
cd /Users/anthonyulloa/Desktop/Projects/personal/skills-platform/apps/api
pnpm prisma db push
pnpm prisma db seed
```
This pushes schema changes and runs seeding without dropping the database.

### Verifying Seeded Data

**Using Prisma Studio:**
```bash
cd /Users/anthonyulloa/Desktop/Projects/personal/skills-platform/apps/api
pnpm prisma studio
```

**Using Direct Queries:**
```bash
# Count profiles by seniority
SELECT "currentSeniorityLevel", COUNT(*) FROM "Profile" GROUP BY "currentSeniorityLevel";

# Verify Tech Leads
SELECT p.name, pr."name" as project, p."currentSeniorityLevel"
FROM "Project" pr
JOIN "Profile" p ON pr."techLeadId" = p.id;

# Check assignment distribution
SELECT "profileId", COUNT(*) as assignment_count
FROM "Assignment"
GROUP BY "profileId"
ORDER BY assignment_count DESC;
```

**Expected Counts:**
- Profiles: 25
- Projects: 7
- Assignments: 40-45
- Employee Skills: 125-175 (3-7 per profile)
- Suggestions: 50-75 (1-3 per profile)
- Seniority History: 50-75
- Skills: 136 (preserved)

## Testing

Run the seed tests:

```bash
cd /Users/anthonyulloa/Desktop/Projects/personal/skills-platform/apps/api
pnpm test seed.spec
```

Tests verify:
- Seed infrastructure utilities
- Profile and seniority generation
- Project and assignment distribution
- Employee skill validation
- Skill suggestion generation
- Idempotent seeding behavior
- Data integrity validations
- End-to-end workflow

## Technical Details

### Deterministic Seeding
The seed script uses Faker.js with a fixed seed (12345) to ensure reproducible data:
```typescript
initializeFaker(12345);
```

Running the seed multiple times produces the same names, emails, and data structure.

### Transaction Safety
All seeding operations are wrapped in a Prisma transaction with a 30-second timeout:
```typescript
await prisma.$transaction(async (tx) => {
  // Cleanup and seeding logic
}, { timeout: 30000 });
```

If any operation fails, the entire transaction rolls back.

### Context-Aware Skill Matching
Employee skills and suggestions align with project assignments:
- Mobile projects → employees have MOBILE, FRONTEND, iOS, ANDROID skills
- Backend projects → employees have BACKEND, DATABASE, CLOUD skills
- Full-stack projects → employees have a mix of disciplines

This ensures realistic skill profiles for each employee.

### Seniority-Based Proficiency
Proficiency levels are distributed based on seniority:
- **Junior:** NOVICE, INTERMEDIATE, ADVANCED (no EXPERT)
- **Mid:** All levels with emphasis on INTERMEDIATE/ADVANCED
- **Senior:** INTERMEDIATE, ADVANCED, EXPERT
- **Lead:** Majority ADVANCED/EXPERT

## Development Workflow

1. **Make Schema Changes:**
   ```bash
   cd /Users/anthonyulloa/Desktop/Projects/personal/skills-platform/apps/api
   # Edit schema.prisma
   pnpm prisma migrate dev --name your_migration_name
   ```

2. **Update Seed Scripts:**
   Edit seed files in `prisma/seeds/` to generate data for new models

3. **Test Seeding:**
   ```bash
   pnpm prisma db seed
   pnpm test seed.spec
   ```

4. **Commit Changes:**
   ```bash
   git add prisma/
   git commit -m "feat: update seeding for new schema"
   ```

## Contributing

When adding new seed functionality:

1. Create a new seed file in `prisma/seeds/` if needed
2. Export an async function that accepts `PrismaClient`
3. Import and call from `sample-data.seed.ts` or `seed.ts`
4. Add utility functions to `seed-utils.ts` for reusability
5. Write tests in `seed.spec.ts`
6. Update this README with documentation

## Related Files

- **Schema:** `/apps/api/prisma/schema.prisma`
- **Migrations:** `/apps/api/prisma/migrations/`
- **Main Seed:** `/apps/api/prisma/seed.ts`
- **Package Config:** `/apps/api/package.json` (prisma.seed section)
